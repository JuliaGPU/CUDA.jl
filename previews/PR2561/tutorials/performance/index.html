<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Performance Tips · CUDA.jl</title><meta name="title" content="Performance Tips · CUDA.jl"/><meta property="og:title" content="Performance Tips · CUDA.jl"/><meta property="twitter:title" content="Performance Tips · CUDA.jl"/><meta name="description" content="Documentation for CUDA.jl."/><meta property="og:description" content="Documentation for CUDA.jl."/><meta property="twitter:description" content="Documentation for CUDA.jl."/><meta property="og:url" content="https://cuda.juliagpu.org/stable/tutorials/performance/"/><meta property="twitter:url" content="https://cuda.juliagpu.org/stable/tutorials/performance/"/><link rel="canonical" href="https://cuda.juliagpu.org/stable/tutorials/performance/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154489943-2"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-154489943-2', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="CUDA.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CUDA.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../introduction/">Introduction</a></li><li><a class="tocitem" href="../custom_structs/">Using custom structs</a></li><li class="is-active"><a class="tocitem" href>Performance Tips</a><ul class="internal"><li><a class="tocitem" href="#General-Tips"><span>General Tips</span></a></li><li><a class="tocitem" href="#Resources"><span>Resources</span></a></li><li><a class="tocitem" href="#Julia-Specific-Tips"><span>Julia Specific Tips</span></a></li></ul></li></ul></li><li><span class="tocitem">Installation</span><ul><li><a class="tocitem" href="../../installation/overview/">Overview</a></li><li><a class="tocitem" href="../../installation/conditional/">Conditional use</a></li><li><a class="tocitem" href="../../installation/troubleshooting/">Troubleshooting</a></li></ul></li><li><span class="tocitem">Usage</span><ul><li><a class="tocitem" href="../../usage/overview/">Overview</a></li><li><a class="tocitem" href="../../usage/workflow/">Workflow</a></li><li><a class="tocitem" href="../../usage/array/">Array programming</a></li><li><a class="tocitem" href="../../usage/memory/">Memory management</a></li><li><a class="tocitem" href="../../usage/multitasking/">Tasks and threads</a></li><li><a class="tocitem" href="../../usage/multigpu/">Multiple GPUs</a></li></ul></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../development/profiling/">Benchmarking &amp; profiling</a></li><li><a class="tocitem" href="../../development/kernel/">Kernel programming</a></li><li><a class="tocitem" href="../../development/troubleshooting/">Troubleshooting</a></li><li><a class="tocitem" href="../../development/debugging/">Debugging</a></li></ul></li><li><span class="tocitem">API reference</span><ul><li><a class="tocitem" href="../../api/essentials/">Essentials</a></li><li><a class="tocitem" href="../../api/array/">Array programming</a></li><li><a class="tocitem" href="../../api/kernel/">Kernel programming</a></li><li><a class="tocitem" href="../../api/compiler/">Compiler</a></li></ul></li><li><span class="tocitem">Library reference</span><ul><li><a class="tocitem" href="../../lib/driver/">CUDA driver</a></li></ul></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Performance Tips</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Performance Tips</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaGPU/CUDA.jl/blob/master/docs/src/tutorials/performance.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Performance-Tips"><a class="docs-heading-anchor" href="#Performance-Tips">Performance Tips</a><a id="Performance-Tips-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Tips" title="Permalink"></a></h1><h2 id="General-Tips"><a class="docs-heading-anchor" href="#General-Tips">General Tips</a><a id="General-Tips-1"></a><a class="docs-heading-anchor-permalink" href="#General-Tips" title="Permalink"></a></h2><p>Always start by profiling your code (see the <a href="../../development/profiling/">Profiling</a> page for more details). You first want to analyze your application as a whole, using <code>CUDA.@profile</code> or NSight Systems, identifying hotspots and bottlenecks. Focusing on these you will want to:</p><ul><li>Minimize data transfer between the CPU and GPU, you can do this by getting rid of unnecessary memory copies and batching many small transfers into larger ones;</li><li>Identify problematic kernel invocations: you may be launching thousands of kernels which could be fused into a single call;</li><li>Find stalls, where the CPU isn&#39;t submitting work fast enough to keep the GPU busy.</li></ul><p>If that isn&#39;t sufficient, and you identified a kernel that executes slowly, you can try using NSight Compute to analyze that kernel in detail. Some things to try in order of importance:</p><ul><li>Optimize memory accesses, e.g., avoid needless global accesses (buffering in shared memory instead) or coalesce accesses;</li><li>Launch more threads on each streaming multiprocessor, this can be achieved by lowering register pressure or reducing shared memory usage, the tips below outline the various ways in which register pressure can be reduced;</li><li>Use 32 bit types like <code>Float32</code> and <code>Int32</code> instead of 64 bit types like <code>Float64</code> and <code>Int</code>/<code>Int64</code>;</li><li>Avoid the use of control flow which cause threads in the same warp to diverge, i.e., make sure <code>while</code> or <code>for</code> loops behave identically across the entire warp, and replace <code>if</code>s that diverge within a warp with <code>ifelse</code>s;</li><li>Increase the arithmetic intensity in order for the GPU to be able to hide the latency of memory accesses.</li></ul><h3 id="Inlining"><a class="docs-heading-anchor" href="#Inlining">Inlining</a><a id="Inlining-1"></a><a class="docs-heading-anchor-permalink" href="#Inlining" title="Permalink"></a></h3><p>Inlining can reduce register usage and thus speed up kernels. To force inlining of all functions use <code>@cuda always_inline=true</code>.</p><h3 id="Limiting-the-Maximum-Number-of-Registers-Per-Thread"><a class="docs-heading-anchor" href="#Limiting-the-Maximum-Number-of-Registers-Per-Thread">Limiting the Maximum Number of Registers Per Thread</a><a id="Limiting-the-Maximum-Number-of-Registers-Per-Thread-1"></a><a class="docs-heading-anchor-permalink" href="#Limiting-the-Maximum-Number-of-Registers-Per-Thread" title="Permalink"></a></h3><p>The number of threads that can be launched is partly determined by the number of registers a kernel uses. This is due to registers being shared between all threads on a multiprocessor. Setting the maximum number of registers per thread will force less registers to be used which can increase thread count at the expense of having to spill registers into local memory, this may improve performance. To set the max registers to 32 use <code>@cuda maxregs=32</code>.</p><h3 id="FastMath"><a class="docs-heading-anchor" href="#FastMath">FastMath</a><a id="FastMath-1"></a><a class="docs-heading-anchor-permalink" href="#FastMath" title="Permalink"></a></h3><p>Use <code>@fastmath</code> to use faster versions of common mathematical functions and use <code>@cuda fastmath=true</code> for even faster square roots.</p><h2 id="Resources"><a class="docs-heading-anchor" href="#Resources">Resources</a><a id="Resources-1"></a><a class="docs-heading-anchor-permalink" href="#Resources" title="Permalink"></a></h2><p>For further information you can check out these resources.</p><p>NVidia&#39;s technical blog has a lot of good tips: <a href="https://developer.nvidia.com/blog/tag/pro-tip/">Pro-Tips</a>, <a href="https://developer.nvidia.com/blog/tag/optimization/">Optimization</a>.</p><p>The <a href="https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/index.html">CUDA C++ Best Practices Guide</a> is relevant for Julia.</p><p>The following notebooks also have some good tips: <a href="https://github.com/maleadt/juliacon21-gpu_workshop/blob/main/deep_dive/CUDA.ipynb">JuliaCon 2021 GPU Workshop</a>, <a href="https://github.com/JuliaComputing/Training/tree/master/AdvancedGPU">Advanced Julia GPU Training</a>.</p><p>Also see the <a href="https://github.com/JuliaGPU/CUDA.jl/tree/master/perf">perf</a> folder for some optimised code examples.</p><h2 id="Julia-Specific-Tips"><a class="docs-heading-anchor" href="#Julia-Specific-Tips">Julia Specific Tips</a><a id="Julia-Specific-Tips-1"></a><a class="docs-heading-anchor-permalink" href="#Julia-Specific-Tips" title="Permalink"></a></h2><h3 id="Minimise-Runtime-Exceptions"><a class="docs-heading-anchor" href="#Minimise-Runtime-Exceptions">Minimise Runtime Exceptions</a><a id="Minimise-Runtime-Exceptions-1"></a><a class="docs-heading-anchor-permalink" href="#Minimise-Runtime-Exceptions" title="Permalink"></a></h3><p>Many common operations can throw errors at runtime in Julia, they often do this by branching and calling a function in that branch both of which are slow on GPUs. Using <code>@inbounds</code> when indexing into arrays will eliminate exceptions due to bounds checking. Note that running code with <code>--check-bounds=yes</code> (the default for <code>Pkg.test</code>) will always emit bounds checking. You can also use <code>assume</code> from the package LLVM.jl to get rid of exceptions, e.g.</p><pre><code class="language-julia hljs">using LLVM.Interop

function test(x, y)
    assume(x &gt; 0)
    div(y, x)
end</code></pre><p>The <code>assume(x &gt; 0)</code> tells the compiler that there cannot be a divide by 0 error.</p><p>For more information and examples check out <a href="https://github.com/JuliaComputing/Training/blob/master/AdvancedGPU/2-2-kernel_analysis_optimization.ipynb">Kernel analysis and optimization</a>.</p><h3 id="32-bit-Integers"><a class="docs-heading-anchor" href="#32-bit-Integers">32-bit Integers</a><a id="32-bit-Integers-1"></a><a class="docs-heading-anchor-permalink" href="#32-bit-Integers" title="Permalink"></a></h3><p>Use 32-bit integers where possible. A common source of register pressure is the use of 64-bit integers when only 32-bits are required. For example, the hardware&#39;s indices are 32-bit integers, but Julia&#39;s literals are Int64&#39;s which results in expressions like <code>blockIdx().x-1</code> to be promoted to 64-bit integers. To use 32-bit integers we can instead replace the <code>1</code> with <code>Int32(1)</code> or more succintly <code>1i32</code> if you run <code>using CUDA: i32</code>.</p><p>To see how much of a difference this makes let&#39;s use a kernel introduced in the introductory tutorial for inplace addition.</p><pre><code class="language-julia hljs">using CUDA, BenchmarkTools

function gpu_add3!(y, x)
    index = (blockIdx().x - 1) * blockDim().x + threadIdx().x
    stride = gridDim().x * blockDim().x
    for i = index:stride:length(y)
        @inbounds y[i] += x[i]
    end
    return
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">gpu_add3! (generic function with 1 method)</code></pre><p>Now let&#39;s see how many registers are used:</p><pre><code class="language-julia hljs">x_d = CUDA.fill(1.0f0, 2^28)
y_d = CUDA.fill(2.0f0, 2^28)

CUDA.registers(@cuda gpu_add3!(y_d, x_d))</code></pre><pre><code class="nohighlight hljs">  29</code></pre><p>Our kernel using 32-bit integers is below:</p><pre><code class="language-julia hljs">function gpu_add4!(y, x)
    index = (blockIdx().x - Int32(1)) * blockDim().x + threadIdx().x
    stride = gridDim().x * blockDim().x
    for i = index:stride:length(y)
        @inbounds y[i] += x[i]
    end
    return
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">gpu_add4! (generic function with 1 method)</code></pre><pre><code class="language-julia hljs">CUDA.registers(@cuda gpu_add4!(y_d, x_d))</code></pre><pre><code class="nohighlight hljs">  28</code></pre><p>So we use one less register by switching to 32 bit integers, for kernels using even more 64 bit integers we would expect to see larger falls in register count.</p><h3 id="Avoiding-StepRange"><a class="docs-heading-anchor" href="#Avoiding-StepRange">Avoiding <code>StepRange</code></a><a id="Avoiding-StepRange-1"></a><a class="docs-heading-anchor-permalink" href="#Avoiding-StepRange" title="Permalink"></a></h3><p>In the previous kernel in the for loop we iterated over <code>index:stride:length(y)</code>, this is a <code>StepRange</code>. Unfortunately, constructing a <code>StepRange</code> is slow as they can throw errors and they contain unnecessary computation when we just want to loop over them. Instead it is faster to use a while loop like so:</p><pre><code class="language-julia hljs">function gpu_add5!(y, x)
    index = (blockIdx().x - Int32(1)) * blockDim().x + threadIdx().x
    stride = gridDim().x * blockDim().x

    i = index
    while i &lt;= length(y)
        @inbounds y[i] += x[i]
        i += stride
    end
    return
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">gpu_add5! (generic function with 1 method)</code></pre><p>The benchmark<sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup>:</p><pre><code class="language-julia hljs">function bench_gpu4!(y, x)
    kernel = @cuda launch=false gpu_add4!(y, x)
    config = launch_configuration(kernel.fun)
    threads = min(length(y), config.threads)
    blocks = cld(length(y), threads)

    CUDA.@sync kernel(y, x; threads, blocks)
end

function bench_gpu5!(y, x)
    kernel = @cuda launch=false gpu_add5!(y, x)
    config = launch_configuration(kernel.fun)
    threads = min(length(y), config.threads)
    blocks = cld(length(y), threads)

    CUDA.@sync kernel(y, x; threads, blocks)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">bench_gpu5! (generic function with 1 method)</code></pre><pre><code class="language-julia hljs">@btime bench_gpu4!($y_d, $x_d)</code></pre><pre><code class="nohighlight hljs">  76.149 ms (57 allocations: 3.70 KiB)</code></pre><pre><code class="language-julia hljs">@btime bench_gpu5!($y_d, $x_d)</code></pre><pre><code class="nohighlight hljs">  75.732 ms (58 allocations: 3.73 KiB)</code></pre><p>This benchmark shows there is a only a small performance benefit for this kernel however we can see a big difference in the amount of registers used, recalling that 28 registers were used when using a <code>StepRange</code>:</p><pre><code class="language-julia hljs">CUDA.registers(@cuda gpu_add5!(y_d, x_d))</code></pre><pre><code class="nohighlight hljs">  12</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>Conducted on Julia Version 1.9.2, the benefit of this technique should be reduced on version 1.10 or by using <code>always_inline=true</code> on the <code>@cuda</code> macro, e.g. <code>@cuda always_inline=true launch=false gpu_add4!(y, x)</code>.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../custom_structs/">« Using custom structs</a><a class="docs-footer-nextpage" href="../../installation/overview/">Overview »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Thursday 21 November 2024 17:15">Thursday 21 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
